name: Deploy to VM

on:
    push:
        branches:
            - deployment

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up SSH
              uses: webfactory/ssh-agent@v0.5.3
              with:
                  ssh-private-key: ${{ secrets.VM_SSH_PRIVATE_KEY }}

            # - name: Build and run frontend Docker container
            #   run: |
            #       echo "Building and running frontend Docker container..."
            #       ssh -o StrictHostKeyChecking=no ubuntu@141.148.202.130 << 'EOF'
            #         cd /var/www/taskmanager-frontend
            #         docker build -t frontend:latest .
            #         docker stop frontend || true
            #         docker rm frontend || true
            #         docker run --restart unless-stopped -d --name frontend -p 3000:80 frontend:latest
            #         sudo systemctl restart nginx
            #       EOF

            - name: Build and run backend Docker container
              run: |
                  echo "Building and running backend Docker container..."
                  ssh -o StrictHostKeyChecking=no ubuntu@141.148.202.130 << 'EOF'
                    cd /var/www/taskmanager-backend
                    docker build -t backend:latest .
                    docker stop backend || true
                    docker rm backend || true
                    echo uluulu
                    echo ${{secrets.PORT}}
                    echo uluulu
                    docker run -d --restart unless-stopped --name backend -p 8000:8000 \
                      -e PORT=${{ secrets.PORT }} \
                      -e CORS=${{secrets.CORS}} \
                      -e ENDPOINT=${{secrets.ENDPOINT}} \
                      -e PUBLIC_STORAGE=${{secrets.PUBLIC_STORAGE}} \
                      -e MONGO_DB_URI=${{secrets.MONGO_DB_URI}} \
                      -e DB_NAME=${{secrets.DB_NAME}} \
                      -e EMAIL_USERNAME=${{secrets.EMAIL_USERNAME}} \
                      -e EMAIL_PASSWORD=${{secrets.EMAIL_PASSWORD}} \
                      -e CORS_ORIGINS=${{secrets.CORS_ORIGINS}} \
                      backend:latest
                  EOF
